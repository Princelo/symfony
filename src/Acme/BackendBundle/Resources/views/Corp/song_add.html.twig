{% extends 'AcmeBackendBundle:Default:layout.html.twig' %}
{% block body %}
<div class="backend-form song-add-form">
    {{ form_start(form) }}
    <table class="table table-striped">
        <tr>
            <td>{{ form_label(form.song.strTitle) }}<span class="red">*</span></td>
            <td>{{ form_widget(form.song.strTitle) }}<span class="form_errors">{{ form_errors(form.song.strTitle) }}</span></td>
        </tr>
        <tr>
            <td><label>歌手</label><span class="red">*</span></td>
            <td>
                <ul class="tags" data-prototype="{% if form.song.arrStrArtistName.vars.prototype is defined %}
                                    {{ form_widget(form.song.arrStrArtistName.vars.prototype.name)|e }}
                                    {% endif %}">
                    {# iterate over each existing tag and render its only field: name #}
                    {% for tag in form.song.arrStrArtistName %}
                        {% if loop.index == 1 %}
                            <li>{{ form_widget(tag.name,  { 'attr': {'data-validate' : 'required'} }) }}</li>
                        {% else %}
                            <li>{{ form_widget(tag.name) }}</li>
                        {% endif %}
                    {% endfor %}
                </ul>
                <span class="tip">(请至少填写一名歌手)</span>
            </td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.strSpecial) }}</td>
            <td>{{ form_widget(form.song.strSpecial) }}<span class="form_errors">{{ form_errors(form.song.strSpecial) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.strLyricist) }}</td>
            <td>{{ form_widget(form.song.strLyricist) }}<span class="form_errors">{{ form_errors(form.song.strLyricist) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.strComposer) }}</td>
            <td>{{ form_widget(form.song.strComposer) }}<span class="form_errors">{{ form_errors(form.song.strComposer) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.strCorpName) }}<span class="red">*</span></td>
            <td>{{ form_widget(form.song.strCorpName) }}<span class="form_errors">{{ form_errors(form.song.strCorpName) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.boolIsRank) }}</td>
            <td>{{ form_widget(form.song.boolIsRank) }}<span class="form_errors">{{ form_errors(form.song.boolIsRank) }}</span></td>
        </tr>
        <tr>
            <td><label>打榜时间</label></td>
            <td>从{{ form_widget(form.song.timeRankTimeFrom) }}到{{ form_widget(form.song.timeRankTimeTo) }}
                <span class="form_errors">{{ form_errors(form.song.timeRankTimeFrom) }}</span>
                <span class="form_errors">{{ form_errors(form.song.timeRankTimeTo) }}</span>
            </td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.intRankZone) }}<span class="red">*</span></td>
            <td>{{ form_widget(form.song.intRankZone) }}<span class="form_errors">{{ form_errors(form.song.intRankZone) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.boolIsPremiere) }}</td>
            <td>{{ form_widget(form.song.boolIsPremiere) }}<span class="form_errors">{{ form_errors(form.song.boolIsPremiere) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.boolIsMain) }}</td>
            <td>{{ form_widget(form.song.boolIsMain) }}<span class="form_errors">{{ form_errors(form.song.boolIsMain) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.intCategory) }}<span class="red">*</span></td>
            <td>{{ form_widget(form.song.intCategory) }}<span class="form_errors">{{ form_errors(form.song.intCategory) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.intStyle) }}<span class="red">*</span></td>
            <td>{{ form_widget(form.song.intStyle) }}<span class="form_errors">{{ form_errors(form.song.intStyle) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.strPromotionFile) }}</td>
            <td>{{ form_widget(form.song.strPromotionFile) }}<span class="form_errors">{{ form_errors(form.song.strPromotionFile) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.strCoverFile) }}</td>
            <td>{{ form_widget(form.song.strCoverFile) }}<span class="form_errors">{{ form_errors(form.song.strCoverFile) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.strLyricFile) }}</td>
            <td>{{ form_widget(form.song.strLyricFile) }}<span class="form_errors">{{ form_errors(form.song.strLyricFile) }}</span></td>
        </tr>
        <tr>
            <td>{{ form_label(form.song.strAuthFile) }}<span class="red">*</span></td>
            <td>{{ form_widget(form.song.strAuthFile) }}<span class="form_errors">{{ form_errors(form.song.strAuthFile) }}</span></td>
        </tr>
        <tr>
            <td><label>上传歌曲</label><span class="red">*</span></td>
            <td>
                <span class="btn btn-success fileinput-button">
                    <i class="glyphicon glyphicon-plus"></i>
                    <span>选择文件...</span>
                    <input id="fileupload" type="file" name="files" style=""/>
                </span><br />
                {{ form_widget(form.song.strSongFile) }}<br />
                上传进度：<span class="myprogress"></span>
                <div id="progress" class="progress" style="width:500px;">
                    <div class="progress-bar progress-bar-success"></div>
                </div>
                <div id="files" class="files"></div>
            </td>
        </tr>
        <tr>
            <td><label>添加试听外部链接</label></td>
            <td>
                试听地址1: {{ form_widget(form.song.strOtherLink1) }}<span class="form_errors">{{ form_errors(form.song.strOtherLink1) }}</span><br />
                试听地址1: {{ form_widget(form.song.strOtherLink2) }}<span class="form_errors">{{ form_errors(form.song.strOtherLink2) }}</span><br />
                试听地址1: {{ form_widget(form.song.strOtherLink3) }}<span class="form_errors">{{ form_errors(form.song.strOtherLink3) }}</span><br />
            </td>
        </tr>
    </table>
    {{ form_end(form) }}
</div>
<script>
    $(function () {
        'use strict';
        // Change this to the location of your server-side upload handler:
        var url = '{{ oneup_uploader_endpoint('gallery') }}',
                uploadButton = $('<input type=\"button\"/>')
                        .addClass('btn btn-primary')
                        .prop('disabled', true)
                        .val('上传中...')
                        .on('click', function () {
                            var $this = $(this),
                                    data = $this.data();
                            $this
                                    .off('click')
                                    .val('Abort')
                                    .on('click', function () {
                                        $this.remove();
                                        data.abort();
                                    });
                            data.submit().always(function () {
                                $this.remove();
                            });
                        });
        $('#fileupload').fileupload({
            url: url,
            dataType: 'json',
            autoUpload: false,
            acceptFileTypes: /(\.|\/)(wma|mp3|wav)$/i,
            maxFileSize: 100000000, // 100 MB
            // Enable image resizing, except for Android and Opera,
            // which actually support image resizing, but fail to
            // send Blob objects via XHR requests:
            disableImageResize: /Android(?!.*Chrome)|Opera/
                    .test(window.navigator.userAgent),
            previewMaxWidth: 100,
            previewMaxHeight: 100,
            previewCrop: true
        }).on('fileuploadadd', function (e, data) {
            data.context = $('<div/>').appendTo('#files');
            $.each(data.files, function (index, file) {
                var node = $('<p/>')
                        .append($('<span/>').text(file.name));
                if (!index) {
                    node
                            .append('<br>')
                            .append(uploadButton.clone(true).data(data));
                }
                node.appendTo(data.context);
            });
        }).on('fileuploadprocessalways', function (e, data) {
            var index = data.index,
                    file = data.files[index],
                    node = $(data.context.children()[index]);
            if (file.preview) {
                node
                        .prepend('<br>')
                        .prepend(file.preview);
            }
            if (file.error) {
                node
                        .append('<br>')
                        .append($('<span class="text-danger"/>').text(file.error));
            }
            if (index + 1 === data.files.length) {
                data.context.find('input[type=\"button\"]')
                        .val('上传')
                        .prop('disabled', !!data.files.error);
            }
        }).on('fileuploadprogressall', function (e, data) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress .progress-bar').css(
                    'width',
                    progress + '%'
            );
            $('.myprogress').html(progress+'%');
        }).on('fileuploaddone', function (e, data) {
            $('#fileupload').attr('disabled', 'disabled');
            $('.songinput').val(data.result.files[0].gen_name);
            console.log(data.result.files[0].gen_name);
            $('button[type=\"submit\"]').removeAttr('disabled');
            $('button[type=\"submit\"]').text('提交');
            $.each(data.result.files, function (index, file) {
                if (file.url) {
                    var link = $('<a>')
                            .attr('target', '_blank')
                            .prop('href', file.url);
                    $(data.context.children()[index])
                            .wrap(link);
                } else if (file.error) {
                    var error = $('<span class="text-danger"/>').text(file.error);
                    $(data.context.children()[index])
                            .append('<br>')
                            .append(error);
                }
            });
        }).on('fileuploadfail', function (e, data) {
            $.each(data.files, function (index) {
                var error = $('<span class="text-danger"/>').text('File upload failed.');
                $(data.context.children()[index])
                        .append('<br>')
                        .append(error);
            });
        }).prop('disabled', !$.support.fileInput)
                .parent().addClass($.support.fileInput ? undefined : 'disabled');
    });
    var $collectionHolder;

    // setup an "add a tag" link
    var $addTagLink = $('<a href="#" class="add_tag_link">添加歌手</a>');
    var $newLinkLi = $('<li></li>').append($addTagLink);

    jQuery(document).ready(function() {
        //var $addTagLink = $('.add_tag_link');
        // Get the ul that holds the collection of tags
        $collectionHolder = $('ul.tags');

        // add the "add a tag" anchor and li to the tags ul
        $collectionHolder.append($newLinkLi);

        // count the current form inputs we have (e.g. 2), use that as the new
        // index when inserting a new item (e.g. 2)
        $collectionHolder.data('index', $collectionHolder.find(':input').length);

        $addTagLink.bind('click', function(e) {
            // prevent the link from creating a "#" on the URL
            e.preventDefault();

            // add a new tag form (see next code block)
            addTagForm($collectionHolder, $newLinkLi);
        });
    });
    function addTagForm($collectionHolder, $newLinkLi) {
        // Get the data-prototype explained earlier
        var prototype = $collectionHolder.attr('data-prototype');

        // get the new index
        var index = $collectionHolder.data('index');

        // Replace '__name__' in the prototype's HTML to
        // instead be a number based on how many items we have
        var newForm = prototype.replace(/__name__/g, index);

        // increase the index with one for the next item
        $collectionHolder.data('index', index + 1);

        // Display the form in the page in an li, before the "Add a tag" link li
        var $newFormLi = $('<li></li>').append(newForm);
        $newLinkLi.before($newFormLi);
    }
</script>
{% endblock %}
